#!/bin/sh

[ -z $1 ] && echo "Usage: $0 <namespace>" && exit 1

NAMESPACE=$1

if [ $(docker inspect --format='{{.State.Running}}' $(docker-compose ps -q mongo)) = false ]; then
    echo "ERROR: mongo container is not running"
    exit 1
fi

EXISTS=$(docker-compose exec -T mongo mongo main --quiet --eval "db.namespaces.find({ name: '$NAMESPACE' })")

if [ -z "$EXISTS" ]; then
    echo "ERROR: namespace does not exists!"
    exit 1
fi

TENANT_ID=`docker-compose exec -T mongo mongo main --quiet --eval "JSON.stringify(db.namespaces.findOne({ name:'$NAMESPACE' }))" | docker run --rm -i imega/jq -r '.tenant_id // empty'`

for COL in devices sessions connected_devices firewall_rules public_keys recorded_sessions; do
    docker-compose exec -T mongo mongo main --quiet --eval "db.$COL.remove({ tenant_id: '$TENANT_ID' }).nRemoved" > /dev/null
done

REMOVED=`docker-compose exec -T mongo mongo main --quiet --eval "db.namespaces.remove({name: '$NAMESPACE'}).nRemoved"`

if [ $REMOVED -gt 0 ]; then
    echo "Namespace deleted"
else
    echo "ERROR: Failed to delete namespace"
fi
